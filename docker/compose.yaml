# SDR Satellite Capture System
#
# Service modes:
#   docker compose -f docker/compose.yaml up                    - Full mode (everything on one machine)
#   docker compose -f docker/compose.yaml --profile sdr-relay up - SDR relay only (on Pi with SDR)
#   docker compose -f docker/compose.yaml --profile server up    - Server only (connects to remote SDR)
#
# Environment variables for server mode:
#   SDR_RELAY_URL=http://your-pi-ip:3001

services:
  # Full mode: Everything on one machine (default)
  # Runs with: docker compose -f docker/compose.yaml up
  rfcapture:
    image: ghcr.io/milesburton/noaa-satellite-capture:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
      args:
        BASE_IMAGE: ghcr.io/milesburton/noaa-satellite-capture-base:latest
    container_name: rfcapture
    restart: unless-stopped
    # No profile = runs by default with `docker compose up`
    devices:
      - /dev/bus/usb:/dev/bus/usb
    privileged: true
    ports:
      - "${DEPLOY_PORT:-80}:3000"
    volumes:
      - rfcapture-data:/app/data
      - rfcapture-recordings:/app/recordings
      - rfcapture-images:/app/images
    environment:
      - SERVICE_MODE=full
      - STATION_LATITUDE=${STATION_LATITUDE:-51.5069}
      - STATION_LONGITUDE=${STATION_LONGITUDE:--0.1276}
      - STATION_ALTITUDE=${STATION_ALTITUDE:-10}
      - SDR_GAIN=${SDR_GAIN:-45}
      - SDR_SAMPLE_RATE=${SDR_SAMPLE_RATE:-48000}
      - SDR_PPM_CORRECTION=${SDR_PPM_CORRECTION:-0}
      - MIN_ELEVATION=${MIN_ELEVATION:-20}
      - MIN_SIGNAL_STRENGTH=${MIN_SIGNAL_STRENGTH:--20}
      - RECORDINGS_DIR=/app/recordings
      - IMAGES_DIR=/app/images
      - DATABASE_PATH=/app/data/captures.db
      - WEB_PORT=3000
      - WEB_HOST=0.0.0.0
      - TLE_UPDATE_INTERVAL_HOURS=${TLE_UPDATE_INTERVAL_HOURS:-24}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # SDR Relay: Lightweight service on Pi with SDR hardware
  sdr-relay:
    image: ghcr.io/milesburton/noaa-satellite-capture:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
      args:
        BASE_IMAGE: ghcr.io/milesburton/noaa-satellite-capture-base:latest
    container_name: sdr-relay
    restart: unless-stopped
    profiles:
      - sdr-relay
    devices:
      - /dev/bus/usb:/dev/bus/usb
    privileged: true
    ports:
      - "${SDR_RELAY_PORT:-3001}:3001"
    volumes:
      - sdr-relay-recordings:/tmp/sdr-relay
    environment:
      - SERVICE_MODE=sdr-relay
      - SDR_RELAY_PORT=3001
      - SDR_RELAY_HOST=0.0.0.0
      - SDR_GAIN=${SDR_GAIN:-45}
      - SDR_SAMPLE_RATE=${SDR_SAMPLE_RATE:-48000}
      - SDR_PPM_CORRECTION=${SDR_PPM_CORRECTION:-0}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Station coords still needed for some satellite info
      - STATION_LATITUDE=${STATION_LATITUDE:-51.5069}
      - STATION_LONGITUDE=${STATION_LONGITUDE:--0.1276}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # Server: API + Frontend + Scheduler (no SDR hardware)
  server:
    image: ghcr.io/milesburton/noaa-satellite-capture:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
      args:
        BASE_IMAGE: ghcr.io/milesburton/noaa-satellite-capture-base:latest
    container_name: rfcapture-server
    restart: unless-stopped
    profiles:
      - server
    ports:
      - "${DEPLOY_PORT:-80}:3000"
    volumes:
      - rfcapture-data:/app/data
      - rfcapture-recordings:/app/recordings
      - rfcapture-images:/app/images
    environment:
      - SERVICE_MODE=server
      - SDR_RELAY_URL=${SDR_RELAY_URL:-http://your-pi-ip:3001}
      - STATION_LATITUDE=${STATION_LATITUDE:-51.5069}
      - STATION_LONGITUDE=${STATION_LONGITUDE:--0.1276}
      - STATION_ALTITUDE=${STATION_ALTITUDE:-10}
      - SDR_GAIN=${SDR_GAIN:-45}
      - SDR_SAMPLE_RATE=${SDR_SAMPLE_RATE:-48000}
      - SDR_PPM_CORRECTION=${SDR_PPM_CORRECTION:-0}
      - MIN_ELEVATION=${MIN_ELEVATION:-20}
      - MIN_SIGNAL_STRENGTH=${MIN_SIGNAL_STRENGTH:--20}
      - RECORDINGS_DIR=/app/recordings
      - IMAGES_DIR=/app/images
      - DATABASE_PATH=/app/data/captures.db
      - WEB_PORT=3000
      - WEB_HOST=0.0.0.0
      - TLE_UPDATE_INTERVAL_HOURS=${TLE_UPDATE_INTERVAL_HOURS:-24}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  rfcapture-data:
  rfcapture-recordings:
  rfcapture-images:
  sdr-relay-recordings:
